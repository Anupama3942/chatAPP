<!DOCTYPE html>
<html>
<head>
    <title>CrypTalk - Secure DOS Chat</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/xterm@5.3.0/css/xterm.css">
    <style>
        body { 
            background: black; 
            margin: 0; 
            padding: 20px;
            font-family: 'Courier New', monospace;
            color: lime;
            overflow: hidden;
        }
        .terminal-container {
            border: 2px solid lime;
            padding: 10px;
            max-width: 1000px;
            margin: 0 auto;
            height: 90vh;
        }
        .status-bar {
            border-bottom: 1px solid lime;
            padding: 5px;
            margin-bottom: 10px;
        }
        #terminal {
            height: calc(100% - 60px);
            width: 100%;
        }
        .help-text {
            color: yellow;
            font-size: 12px;
            margin-top: 5px;
        }
        .user-selection {
            margin: 10px 0;
            padding: 5px;
            border: 1px solid lime;
        }
        select, button {
            background: black;
            color: lime;
            border: 1px solid lime;
            padding: 5px;
            margin: 0 5px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="terminal-container">
        <div class="status-bar">
            <strong>CrypTalk v2.0</strong> | User: {{ username }} | 
            <span id="online-count">0 users online</span> |
            <a href="/logout" style="color:lime;">Logout</a>
        </div>
        
        <div class="user-selection">
            <span>Send to: </span>
            <select id="userSelect">
                <option value="">-- Select User --</option>
            </select>
            <button onclick="showUserList()">Refresh Users</button>
            <span id="selectedUser" style="color:cyan; margin-left: 10px;"></span>
        </div>
        
        <div id="terminal"></div>
        <div class="help-text">
            ðŸ’¡ Select a user from dropdown, type message and press ENTER to send. 
            Only you and the selected user can see messages.
        </div>
    </div>

    <script>
        const userId = "{{ user_id }}";
        const userEmail = "{{ username }}";
        
        // Initialize terminal
        const term = new Terminal({
            cursorBlink: true,
            theme: {
                background: 'black',
                foreground: 'lime'
            },
            fontSize: 14,
            fontFamily: 'Courier New'
        });
        
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        // Socket.io connection
        const socket = io();

        // Store online users and selected user
        const onlineUsersMap = new Map();
        let currentInput = '';
        let selectedUser = null;

        // E2EE Crypto functions
        async function generateKeyPair() {
            try {
                const keyPair = await window.crypto.subtle.generateKey(
                    {
                        name: "ECDH",
                        namedCurve: "P-256"
                    },
                    true,
                    ["deriveKey", "deriveBits"]
                );
                return keyPair;
            } catch (error) {
                console.error("Key generation failed:", error);
                return null;
            }
        }

        async function exportPublicKey(key) {
            const exported = await window.crypto.subtle.exportKey("spki", key);
            return btoa(String.fromCharCode(...new Uint8Array(exported)));
        }

        // User registration with public key
        async function registerUser() {
            try {
                const keyPair = await generateKeyPair();
                if (!keyPair) {
                    term.writeln('\r\nâŒ Failed to generate encryption keys');
                    return;
                }
                
                const publicKey = await exportPublicKey(keyPair.publicKey);
                
                // Register with server
                socket.emit("register", {
                    user_id: userId,
                    email: userEmail,
                    public_key: publicKey
                });
                
                window.userKeyPair = keyPair;
                term.writeln('\r\nðŸ” Encryption keys generated and registered');
                term.writeln('ðŸ’¬ Select a user and type messages (press ENTER to send)');
                term.writeln('ðŸ“± Open another browser window to test with multiple users\r\n');
                term.write('> ');
                
            } catch (error) {
                term.writeln('\r\nâŒ Key generation failed: ' + error.message);
                term.write('> ');
            }
        }

        // Update user dropdown
        function updateUserDropdown() {
            const userSelect = document.getElementById('userSelect');
            const selectedUserSpan = document.getElementById('selectedUser');
            
            userSelect.innerHTML = '<option value="">-- Select User --</option>';
            
            const onlineUsers = Array.from(onlineUsersMap.values());
            const otherUsers = onlineUsers.filter(u => u.user_id !== userId);
            
            otherUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = user.email;
                userSelect.appendChild(option);
            });
            
            // Update selected user display
            if (selectedUser) {
                selectedUserSpan.textContent = `Selected: ${selectedUser.email}`;
            } else {
                selectedUserSpan.textContent = 'No user selected';
            }
        }

        // Socket event handlers
        socket.on("user_list", function(users) {
            document.getElementById('online-count').textContent = `${users.length} users online`;
            
            // Update online users map
            onlineUsersMap.clear();
            users.forEach(user => {
                onlineUsersMap.set(user.user_id, user);
            });
            
            // Update dropdown
            updateUserDropdown();
            
            // Show online users in terminal
            if (users.length > 0) {
                term.write('\x1b[2K\r'); // Clear current line
                term.write(`ðŸ‘¥ Online: ${users.map(u => u.email).join(', ')}`);
                term.write('\r\n> ' + currentInput);
            }
        });

        socket.on("private_message", async function(data) {
            // Only show messages that are meant for this user
            if (data.to_user_id === userId || data.from_user_id === userId) {
                const senderName = data.from_user_id === userId ? 'You' : data.from_email;
                term.writeln(`\r\nðŸ’¬ ${senderName}: ${data.message}`);
                term.write('> ' + currentInput);
            }
        });

        socket.on("connect", function() {
            term.writeln('âœ… Connected to server');
            registerUser();
        });

        socket.on("disconnect", function() {
            term.writeln('\r\nâŒ Disconnected from server');
        });

        // User selection
        document.getElementById('userSelect').addEventListener('change', function() {
            const selectedUserId = this.value;
            if (selectedUserId) {
                selectedUser = onlineUsersMap.get(selectedUserId);
                term.writeln(`\r\nâœ… Selected user: ${selectedUser.email}`);
                term.write('> ' + currentInput);
            } else {
                selectedUser = null;
                term.writeln('\r\nâŒ No user selected');
                term.write('> ' + currentInput);
            }
            updateUserDropdown();
        });

        function showUserList() {
            const onlineUsers = Array.from(onlineUsersMap.values());
            term.writeln('\r\nðŸ“‹ Online Users:');
            onlineUsers.forEach(user => {
                const status = user.user_id === userId ? ' (You)' : '';
                term.writeln(`   ðŸ‘¤ ${user.email}${status}`);
            });
            term.write('> ' + currentInput);
        }

        // Terminal input handling
        term.onData(function(data) {
            if (data === '\r') { // Enter key - send message
                if (currentInput.trim() && selectedUser) {
                    sendMessage(currentInput);
                    currentInput = '';
                    term.write('\r\n> ');
                } else if (currentInput.trim() && !selectedUser) {
                    term.writeln('\r\nâŒ Please select a user first!');
                    term.write('> ' + currentInput);
                } else {
                    term.write('\r\n> ');
                }
            } else if (data === '\x7f') { // Backspace
                if (currentInput.length > 0) {
                    currentInput = currentInput.slice(0, -1);
                    term.write('\b \b');
                }
            } else if (data === '\u0003') { // Ctrl+C
                term.writeln('\r\n^C\r\nType "exit" to logout or continue chatting');
                term.write('> ' + currentInput);
            } else if (data.charCodeAt(0) >= 32) { // Printable characters
                currentInput += data;
                term.write(data);
            }
        });

        function sendMessage(message) {
            if (!selectedUser) {
                term.writeln('\r\nâŒ No user selected! Please choose a user from the dropdown.');
                term.write('> ');
                return;
            }

            // Send plain text message (we'll add encryption later)
            socket.emit("private_message", {
                to_user_id: selectedUser.user_id,
                message: message,
                from_user_id: userId,
                from_email: userEmail
            });
            
            // Show message in your own terminal immediately
            term.writeln(`\r\nðŸ’¬ You â†’ ${selectedUser.email}: ${message}`);
        }

        // Initialize
        term.writeln('ðŸš€ CrypTalk v2.0 - Secure Private Chat');
        term.writeln('ðŸ”Œ Connecting to server...');

        // Handle window resize
        window.addEventListener('resize', () => {
            fitAddon.fit();
        });

        // Focus terminal on click
        term.focus();
    </script>
</body>
</html>